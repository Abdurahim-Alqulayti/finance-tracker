
<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>Statistics</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="stats-container">
    <!-- NEW: Income vs Expenses Comparison Chart -->
    <ion-card>
      <ion-card-content>
        <div class="comparison-chart">
          <!-- Bar Chart -->
          <div class="bar-chart-container">
            <div class="bar-wrapper">
              <div class="bar-label">
                <ion-icon name="trending-up" color="success"></ion-icon>
                <span>Income</span>
              </div>
              <div class="bar-track">
                <div
                  class="bar-fill income-bar"
                  [style.width.%]="incomeBarWidth"
                  [attr.data-value]="'$' + (totalIncome | number:'1.2-2')">
                </div>
              </div>
              <span class="bar-amount">${{ totalIncome | number:'1.2-2' }}</span>
            </div>

            <div class="bar-wrapper">
              <div class="bar-label">
                <ion-icon name="trending-down" color="danger"></ion-icon>
                <span>Expenses</span>
              </div>
              <div class="bar-track">
                <div
                  class="bar-fill expense-bar"
                  [style.width.%]="expenseBarWidth"
                  [attr.data-value]="'$' + (totalExpenses | number:'1.2-2')">
                </div>
              </div>
              <span class="bar-amount">${{ totalExpenses | number:'1.2-2' }}</span>
            </div>
          </div>

          <!-- Donut Chart Comparison -->
          <div class="donut-chart-container">
            <svg [attr.viewBox]="'0 0 ' + donutSize + ' ' + donutSize" class="donut-chart">
              <g [attr.transform]="'translate(' + (donutSize/2) + ',' + (donutSize/2) + ')'">
                <!-- Background circle -->
                <circle
                  r="70"
                  fill="none"
                  stroke="#E5E7EB"
                  stroke-width="35">
                </circle>

                <!-- Income arc -->
                <circle
                  r="70"
                  fill="none"
                  stroke="#48BB78"
                  stroke-width="35"
                  [attr.stroke-dasharray]="incomeArcLength + ' ' + totalCircumference"
                  [attr.stroke-dashoffset]="circumferenceOffset"
                  class="donut-segment income-segment">
                </circle>

                <!-- Expenses arc -->
                <circle
                  r="70"
                  fill="none"
                  stroke="#F56565"
                  stroke-width="35"
                  [attr.stroke-dasharray]="expenseArcLength + ' ' + totalCircumference"
                  [attr.stroke-dashoffset]="circumferenceOffset - incomeArcLength"
                  class="donut-segment expense-segment">
                </circle>

                <!-- Center text -->
                <text
                  text-anchor="middle"
                  dy="0"
                  class="donut-center-text">
                  <tspan x="0" dy="-10" class="donut-label">Total</tspan>
                  <tspan x="0" dy="25" class="donut-value">${{ (totalIncome + totalExpenses) | number:'1.0-0' }}</tspan>
                </text>
              </g>
            </svg>

            <!-- Legend -->
            <div class="donut-legend">
              <div class="legend-item">
                <div class="legend-dot income-dot"></div>
                <span>Income ({{ incomePercentageOfTotal | number:'1.0-0' }}%)</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot expense-dot"></div>
                <span>Expenses ({{ expensePercentageOfTotal | number:'1.0-0' }}%)</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Savings Rate -->
        <div class="savings-rate" *ngIf="totalIncome > 0">
          <div class="savings-header">
            <span>Savings Rate</span>
            <span class="savings-percentage" [class.positive]="savingsRate > 0" [class.negative]="savingsRate < 0">
              {{ savingsRate | number:'1.1-1' }}%
            </span>
          </div>
          <div class="savings-bar">
            <div
              class="savings-fill"
              [style.width.%]="Math.abs(savingsRate)"
              [class.positive-fill]="savingsRate > 0"
              [class.negative-fill]="savingsRate < 0">
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Category Breakdown -->
    <ion-card>

      <ion-segment [(ngModel)]="selectedView" (ionChange)="onViewChange()">
        <ion-segment-button value="expenses">
          <ion-label>Expenses</ion-label>
        </ion-segment-button>
        <ion-segment-button value="income">
          <ion-label>Income</ion-label>
        </ion-segment-button>
      </ion-segment>

      <ion-card-content>
        <div *ngIf="currentCategoryData.length > 0; else noData">
          <!-- Total -->
          <div class="total-display">
            <h2>Total {{ selectedView === 'expenses' ? 'Expenses' : 'Income' }}</h2>
            <h1>${{ currentTotal | number:'1.2-2' }}</h1>
          </div>

          <!-- Category List with Progress Bars -->
          <div class="category-list">
            <div *ngFor="let category of currentCategoryData" class="category-item">
              <div class="category-header">
                <div class="category-info">
                  <div class="color-indicator" [style.background-color]="category.color"></div>
                  <span class="category-name">{{ category.name }}</span>
                </div>
                <div class="category-amount">
                  <span class="amount">${{ category.total | number:'1.2-2' }}</span>
                  <span class="percentage">{{ category.percentage | number:'1.0-0' }}%</span>
                </div>
              </div>

              <!-- Progress Bar -->
              <div class="progress-bar">
                <div
                  class="progress-fill"
                  [style.width.%]="category.percentage"
                  [style.background-color]="category.color">
                </div>
              </div>
            </div>
          </div>
        </div>

        <ng-template #noData>
          <div class="no-data">
            <ion-icon name="pie-chart-outline"></ion-icon>
            <p>No {{ selectedView }} data available</p>
          </div>
        </ng-template>
      </ion-card-content>
    </ion-card>

    <!-- Pie Charts for Category Distribution -->
    <ion-card>
      <ion-card-content>
        <ion-segment [(ngModel)]="selectedChartView" (ionChange)="onChartViewChange()">
          <ion-segment-button value="expenses">
            <ion-label>Expenses</ion-label>
          </ion-segment-button>
          <ion-segment-button value="income">
            <ion-label>Income</ion-label>
          </ion-segment-button>
        </ion-segment>

        <div *ngIf="currentChartData.length > 0; else noChartData" class="chart-container">
          <!-- SVG Pie Chart -->
          <svg [attr.viewBox]="'0 0 ' + chartSize + ' ' + chartSize" class="pie-chart">
            <g [attr.transform]="'translate(' + (chartSize/2) + ',' + (chartSize/2) + ')'">
              <path
                *ngFor="let slice of pieSlices"
                [attr.d]="slice.path"
                [attr.fill]="slice.color"
                class="pie-slice"
                (click)="onSliceClick(slice)">
              </path>
            </g>
          </svg>

          <!-- Chart Legend -->
          <div class="chart-legend">
            <div *ngFor="let category of currentChartData" class="legend-item">
              <div class="legend-color" [style.background-color]="category.color"></div>
              <div class="legend-info">
                <span class="legend-name">{{ category.name }}</span>
                <span class="legend-value">${{ category.total | number:'1.2-2' }} ({{ category.percentage | number:'1.0-0' }}%)</span>
              </div>
            </div>
          </div>
        </div>

        <ng-template #noChartData>
          <div class="no-data">
            <ion-icon name="pie-chart-outline"></ion-icon>
            <p>No {{ selectedChartView }} data available</p>
          </div>
        </ng-template>
      </ion-card-content>
    </ion-card>

  </div>
</ion-content>
